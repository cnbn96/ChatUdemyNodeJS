<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Welcome to {{room.roomName}}</title>
	<link rel="stylesheet" href="/css/room.css">
	<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
	<script src="/socket.io/socket.io.js"></script>
	<script>
		var host = '{{config.host}}',
			messages = 	io.connect(host + '/messages'),
			roomId = '{{room._id}}',
			roomName = '{{room.roomName}}',
			roomNum = '{{room.roomNumber}}',
			userId = '{{user._id}}',
			userName = '{{user.fullName}}',
			userPic = '{{user.profileAvatar}}',
			page = 0;
		//add socket listen on connection


		messages.on('connect', function(){
			console.log('Connection Messages Established!!');
			messages.emit('joinroom', {roomId: roomId,room: roomNum, userName: userName, userPic: userPic});
		});
		messages.on('getMessagesHistory', function(data){
			var messages = JSON.parse(data);
			// for(var i = messages.length-1; i >= 0 ; i--){
			// 	updateMessageFeed(messages[i].chatUser_id.profileAvatar, messages[i].message);
			// }
			if(messages[0] !== null && messages[0] !== undefined){
				$('#loadmore').show();
				for(var i = 0; i < messages.length; i++){
					updateMessageHistory(messages[i].chatUser_id.profileAvatar, messages[i].message);
				}
			}else{
				$('#loadmore').hide();
			}
		});
		messages.on('disconnect', function(){
			messages.emit('outroom', {room: roomNum});
		});
		messages.on('messageFeed', function(data){
			var messages = JSON.parse(data);
			updateMessageFeed(messages.user.userPic, messages.message);
		});
		messages.on('typingFeed', function(data){
			var typing = JSON.parse(data);
			updateTypingFeed(typing.userPic, typing.typing);
		});
		messages.on('')
		$(document).on("click", "#loadmore", function(){
			console.log("LOADMORE CLICKED!");
			messages.emit('getMoreMessages', {roomId: roomId, offset: page});
			page++;
		});
		$(document).on('input paste',function(event){
			if($(event.target).hasClass('newmessage')){
		   	  console.log("abcd");
		   	  if((event.clipboardData || event.originalEvent.clipboardData) !== undefined){
				  var items = (event.clipboardData || event.originalEvent.clipboardData).items;
				  for (index in items) {
				    var item = items[index];
				    if (item.kind === 'file') {
				      var blob = item.getAsFile();
				      var reader = new FileReader();
				      reader.onload = function(event){
				        var pic = '<img src="'+event.target.result+'">';
				        messageEmit(roomNum, userPic, pic);
				      };
				      reader.readAsDataURL(blob);
				    }
				  }
		   	  }
			}
		});
		$(document).on('keyup', '.newmessage',function(e){
			var o = $(this);
			var message = o.val();
			if(e.which == 13 && message != ''){
				messageEmit(roomNum, userPic, message);
			}
		})

		function messageEmit(roomNum, userPic, message){
			var room = {
				"roomId": roomId,
				"roomNumber": roomNum
			};
			messages.emit('newMessage',{
				room: room,
				user: {
					"userId": userId,
					"userPic": userPic
				},
				message : message
			});
			updateMessageFeed(userPic, message);
			$('.newmessage').val('');
		}
		function updateTypingFeed(userPic, typing){
			var str = '<li>';
				str +='<div class="msgbox">';
				str +=	'<div class="msgerpic"><div class="pic"><img src="' + userPic + '"></div></div>';
				str +=	'<div class="msg"><p>' + '...' + '</p></div>';
				str += '</div></li>';
				$(str).hide().appendTo($('.messages')).slideDown(100);
		}
		function updateMessageHistory(userPic, message){
			var str = '<li>';
				str +='<div class="msgbox">';
				str +=	'<div class="msgerpic"><div class="pic"><img src="' + userPic + '"></div></div>';
				str +=	'<div class="msg"><p>' + message + '</p></div>';
				str += '</div></li>'
				$(str).hide().prependTo($('.messages')).slideDown(100);
				//$('.rm-messages').delay(500).scrollTop($('.rm-messages')[0].scrollHeight);
				// setTimeout(function(){
				// 	$('.rm-messages').scrollTop($('.rm-messages')[0].scrollHeight);
				// }, 150);
		}
		function updateMessageFeed(userPic, message){
			var str = '<li>';
				str +='<div class="msgbox">';
				str +=	'<div class="msgerpic"><div class="pic"><img src="' + userPic + '"></div></div>';
				str +=	'<div class="msg"><p>' + message + '</p></div>';
				str += '</div></li>'
				$(str).hide().appendTo($('.messages')).slideDown(100);
				//$('.rm-messages').delay(500).scrollTop($('.rm-messages')[0].scrollHeight);
				setTimeout(function(){
					$('.rm-messages').scrollTop($('.rm-messages')[0].scrollHeight);
				}, 150);
		}

		messages.on('updateUserList', function(data){
			var userList = JSON.parse(data);
			var user = $('.users');
			user.html('');
			for(var i = 0; i<userList.length; i++){
				var flag = true;
				user.children().each(function(){
					var name = $(this).find('h5').html();
					if(name == userList[i].userName){
						flag = false;
					}
				})
				if(flag){
					var str = '<li><img src="' + userList[i].userPic + '"><h5>' + userList[i].userName + '</h5></li>';
					$(str).appendTo(user);
				}
			}
		});
		setInterval(function(){
			messages.emit('updateList', {room: roomNum});
		}, 15 * 1000);

		$(document).on('click','#doUpload', function(){
			var uploadFile = $('#uploadImage');
			if(uploadFile.val() != ''){
				var file = uploadFile[0].files[0];
				uploadNow(file);
			}
		});
		function uploadNow(file){
			var uploadURL = host + '/messageUpload';
			// var uploadFile = $('#uploadImage');
			// if(uploadFile.val() != ''){
				var form = new FormData();
				console.log(uploadURL);
				//form.append('upload', uploadFile[0].files[0]);
				form.append('upload', file);
				form.append('userId', userId);
				form.append('roomId', roomId);
				$.ajax({
					type: "POST",
					processData: false,
					contentType: false,
					dataType: "json",
					url: uploadURL,
					data: form,
					success: function(result){
						var pic = '<img src="https://s3.amazonaws.com/chatcatstorage/'+result.FileName+'">';
						console.log(pic);
						setTimeout(function(){
							messageEmit(roomNum, userPic, pic);
						},500);
					}
				});
			// }
		}

	</script>
</head>
<body>
<div class="rm-container">
		<h1 class="rm-title">ChatCAT</h1>
		<div class="rm-userbox">
			<img src="{{user.profileAvatar}}" class="userPic">
			<h3 class="userName">{{user.fullName}} | <a href="/logout">Logout</a><a href="/chatrooms">More Chatrooms</a></h3>
		</div>
		<div class="rm-roomname">
			<h5>{{room.roomName}}</h5>
		</div>
		<div class="rm-messages">
			<div class="rm-loadmore" style="margin-top: 5px;text-align: center;">
				<a id="loadmore" href="#" style="font-size: 17px;font-weight: bold;text-decoration: underline;">
					Load more messages...</a>
			</div>
			<ul class="messages">
				<!-- <li>
					<div class="msgbox">
						<div class="pic"><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAgAAAQABAAD//gAEKgD/2wBDAAYEBQYFBAYGBQYHBwYIChAKCgkJChQODwwQFxQYGBcUFhYaHSUfGhsjHBYWICwgIyYnKSopGR8tMC0oMCUoKSj/2wBDAQcHBwoIChMKChMoGhYaKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCj/wgARCAAyADIDACIAAREBAhEB/8QAGgAAAgMBAQAAAAAAAAAAAAAAAAMCBAUBBv/EABkBAAIDAQAAAAAAAAAAAAAAAAEDAAIEBf/EABkBAAIDAQAAAAAAAAAAAAAAAAEDAAIEBf/aAAwDAAABEQIRAAABwiqvn7GL1tIM86Z77qeVgghyV66FlDc+2lQsYOnHfM0anfqJXUs1sLXF6CSTVcAgO86RCUZSSWxcPQ5B/8QAIxAAAgICAgAHAQAAAAAAAAAAAQIAAwQSESIFEBMUICFBMf/aAAgBAAABBQLabS3I0K5B4SzcbTacx31Xw+hBXe9dav1yuZzOY/ZUoZ0ZFtbKpCEmeqkxxsLupot5qJImVbHJJmP9V3W7NWx3KWGXNwfIt1n6cw+3+R/k/Z//xAAdEQACAgMAAwAAAAAAAAAAAAAAAQIRAxIhICJB/9oACAECEQE/AbFjb62WWfCNUZZLbhsxy5RinFL2G78v/8QAHBEAAgIDAQEAAAAAAAAAAAAAAAECEQMSIUIg/9oACAEBEQE/AdbHKK4kOBqeqG3Zig2umiFDtsyRl5Eq+v/EACMQAAEDAwQCAwAAAAAAAAAAAAEAAhEQITESICJBUWEwUoH/2gAIAQAABj8CpGSpLDCnYStT4Lj5UEgelww7ZCDrR5TQx99OU3uKZRlCFYq1vxWvK5UJ9rjhBZstA6qG9V0gc/t8f//EAB4QAAMAAgMBAQEAAAAAAAAAAAABESExEEFRYXGR/9oACAEAAAE/IeBEi+I231SQmIfI+WCMnN0Vr3pFsnoZoPhRW3vQvetVto1HbBmTm6vIhKtxH2fwU16hMDZ1BnQsqY9ikzpGOvZYnhCXjirIpUYe9iU3E3BfG42JGz+iyT4h/kZIaw9JU2r6QSuWXPD0M95nw//aAAwDAAABEQIRAAAQHMSBVOE+S5tPVpUF/8QAGxEBAAMAAwEAAAAAAAAAAAAAAQARIRAgMUH/2gAIAQIRAT8QSawzJL6Pzj7ZgdyGXCfDyIBsd3L6/wD/xAAcEQEAAgIDAQAAAAAAAAAAAAABABEQMSAhQfD/2gAIAQERAT8QGqIp3YBSacDqibrzUA45i3RyJPvYQqUcf//EACEQAQACAgIDAQADAAAAAAAAAAEAESExQVFhcYGREOHw/9oACAEAAAE/EAz3hazFtqAgIQvPQipTeQbr3PPPuV8QUaaYO3iAOcSjV8FzQtNw/BHazGIorkr3B7/hZpJl6nZ08Rj66haBkOpfEoKMvP2VqyF7vEVCDauIly+pIG6oR8Ri1AVloFUF3F/7MVNozUD6zc1gsF+hBC4ini3VS7qv2VBCitAVLkaaHbyg5loEPK+jbBqEy/L2g6WeSV/oidZlHa9zIb7mUdjaKes5mHYO53h3btlAEtmqaR17w18QmqO5/9k=">Sachin Bhatnagar</div>
						<div class="msg"><p>Hi there this looks nice !</p></div>
					</div>
				</li> -->
			</ul>
		</div>
		<div class="rm-users">
			<ul class="users">

			</ul>
		</div>
		<div class="rm-newmessage">
			<input type="text" class="newmessage" autocomplete="off" placeholder="Type in your message and press enter !">

		</div>
		<div class="rm-actions" style="
				    position: relative;
				    margin-left: 10px;
				    border: 1px solid;
				    width: 243px;
						height: 65px;
				    display: inline-block;
				    padding: 5px;
				    background: rgb(250, 250, 250);
				    float: left;">
				<input name="uploadImage" id="uploadImage" type="file" class="input-file" style="width: 243px;">
				<button id="doUpload" type="submit" style="
						background: -webkit-linear-gradient(top,#FD8 15%,#F49D00 85%);
				    border: 1px solid #2164A6;
				    color: black;
				    display: block;
				    border-radius: 4px;
				    margin-top: 5px;
				    float: left;
				    line-height: 14px;
				    font-size: 12px;
				    padding: 5px 12px 4px 12px;">UPLOAD</button>
		</div>
	</div>
</body>
</html>
